{% extends "base.html" %}

{% block title %}All routes list{% endblock %}

{% block main %}

{% set ids_to_check = [] %}
{% for id in user_routes_ids %}
  {% set ids_to_check = ids_to_check|merge([id.route_id]) %}
{% endfor %}

<section class="container-fluid">
  <article class="row justify-content-center px-2">
    <div class="col-12">
      <h1 class="py-3 text-center text-primary font-weight-light">Розклад:</h1>
    </div>
    <div class="col-12 col-xl-11">
      <div class="row text-primary">
        <div class="col-4 col-md-2">
          Дата
        </div>
        <div class="col-4 col-md-3">
          Звідки
        </div>
        <div class="col-4 col-md-3">
          Куди
        </div>
      </div>
    </div>
    {% for route in routes %}
    {% set origin = route.origin|split(' ') %}
    {% set destination = route.destination|split(' ') %}
    <div class="col-12 col-xl-11 py-2">
      <div
        class="row py-2 border rounded
        {{ current_user.id == route.driver_id ? 'border-success' }}"
      >
        <!-- Departure and driver -->
        <div class="col-4 col-sm-4 col-md-2">
          {{ route.departure|date('d-m-Y') }}<br />
          <small
           class="{{ current_user.id == route.driver_id ? 'text-success' }}">
            {{ route.name }} {{ route.last_name }}
          </small>
        </div>
        <!-- Origin -->
        <div class="overflow-hidden col-4 col-sm-4 col-md-3 align-self-center font-weight-bold text-dark">
          {% set city = origin|slice(0,2) %}
          {% set county = origin[3:] %}
          {{ city|join(' ') }}
          {{ county|join(' ')}}
        </div>
        <!-- Destination -->
        <div class="overflow-hidden col-4 col-sm-4 col-md-3 align-self-center font-weight-bold text-dark">
          {% set city = destination|slice(0,2) %}
          {% set county = destination[3:] %}
          {{ city|join(' ') }}
          {{ county|join(' ')}}
        </div>
        <!-- Seats -->
        <div class="col-6 col-sm-6 col-md-2 align-self-center text-right">
          {% set freeSeats = route.pax_capacity - route.occupied %}
          {% if freeSeats == 0 %}
          <small class="text-muted">Місць не залишилося.</small>
          {% else %}
          <a href="/routes/details?routeId={{ route.id }}"
            title="Список пасажирів!"
          >
          <small>
            Вільні місця:<br />
              <span class="text-primary font-weight-bold">
                {{ freeSeats }}
              </span>
              з {{ route.pax_capacity }}
          </small>
          </a>
          {% endif %}
        </div>
        <!-- Buttons -->
        <div class="col-6 col-sm-6 col-md-2 d-flex align-items-center justify-content-end">
          {% if freeSeats > 0 and current_user.id != route.driver_id and route.id not in ids_to_check %}
          <form method="post" action="/routes/ride?routeId={{ route.id }}">
            <button type="submit"
              class="btn btn-sm btn-outline-success"
            >
              Го
            </button>
          </form>
          {% elseif route.id in ids_to_check %}
          <form method="post" action="/routes/removePassenger?routeId={{ route.id }}">
            <button type="submit"
              class="ml-1 btn btn-sm btn-outline-danger"
            >
              Відмінити
            </button>
          </form>
          {% endif %}
          <a tabindex="0" role="button"
            class="ml-1 btn btn-sm btn-outline-primary popover-dismiss"
            data-toggle="popover"
            data-trigger="focus"
            title="{{ route.name }} до {{ destination|join(' ') }}"
            data-content="Від'їжджає
            {{ route.departure|localizeddate('long', 'none', locale) }}
              від {{ route.origin }} до {{ route.destination }}
              з {{ route.occupied }}  пасажир{{ route.occupied == 1 ? 'ом' : 'ами'}}."
          >
            Інфо
          </a>
        </div>
      </div>
    </div>
    {% endfor %}
  </article>
</section>
{% endblock %}
